name: Setup pnpm project

description: checkout a source, setup pnpm and Node.js and install dependencies

inputs:
  node-version:
    description: Node.js version
    required: false
  node-version-file:
    description: Node.js version file
    required: false

runs:
  using: composite
  steps:
    - name: Checkout the source
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        show-progress: false
        submodules: recursive

    - name: Setup pnpm
      uses: pnpm/action-setup@eae0cfeb286e66ffb5155f1a79b90583a127a68b # v2.4.1
      with:
        standalone: true

    - name: Determine Node.js version parameters
      id: determine-parameters
      run: |
        # Determine Node.js version parameters

        echo "::group::Determine Node.js version parameters"

        node_version=${{ inputs.node-version }}
        node_version_file=${{ inputs.node-version-file }}

        if [[ $node_version == "" && $node_version_file == "" ]]; then
          echo "Attempting to detect Node.js version file"
          if [[ -e .nvmrc ]]; then
            node_version_file=.nvmrc
          elif [[ -e .node-version ]]; then
            node_version_file=.node-version
          elif [[ -e package.json && $( jq -r .volta.node < package.json ) != "null" ]]; then
            node_version_file=package.json
          else
            echo "No Node.js version file detected"
          fi
        fi

        echo "Result:"

        (
          echo node-version=$node_version
          echo node-version-file=$node_version_file
        ) | tee -a "$GITHUB_OUTPUT"

        echo "::endgroup::"
      shell: bash

    - name: Setup Node.js
      uses: actions/setup-node@1a4442cacd436585916779262731d5b162bc6ec7 # v3.8.2
      with:
        node-version: ${{ steps.determine-parameters.outputs.node-version }}
        node-version-file: ${{ steps.determine-parameters.outputs.node-version-file }}
        cache: pnpm

    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      shell: bash
